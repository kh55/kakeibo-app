name: Deploy to Sakura Internet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        python manage.py test
    
    - name: Collect static files
      run: |
        python manage.py collectstatic --noinput
    
    - name: Create deployment package
      run: |
        # 一時ディレクトリを作成
        mkdir -p temp_deploy
        
        # 必要なファイルをコピー
        cp -r kakeibo_app temp_deploy/
        cp -r kakeibo_project temp_deploy/
        cp -r templates temp_deploy/
        cp -r static temp_deploy/
        cp manage.py temp_deploy/
        cp requirements.txt temp_deploy/
        cp Procfile temp_deploy/
        cp runtime.txt temp_deploy/
        cp env.example temp_deploy/
        cp sakura_settings.py temp_deploy/
        cp env.sakura.example temp_deploy/
        cp gunicorn_sakura.conf.py temp_deploy/
        cp Procfile.sakura temp_deploy/
        cp DEPLOY_SAKURA.md temp_deploy/
        
        # デプロイパッケージを作成
        cd temp_deploy
        tar -czf ../deploy.tar.gz .
        cd ..
        
        # 一時ディレクトリを削除
        rm -rf temp_deploy
    
    - name: Set deploy path
      run: |
        if [ -n "${{ secrets.SAKURA_DEPLOY_PATH }}" ]; then
          echo "DEPLOY_PATH=${{ secrets.SAKURA_DEPLOY_PATH }}" >> $GITHUB_ENV
        else
          echo "DEPLOY_PATH=/home/${{ secrets.SAKURA_USERNAME }}/" >> $GITHUB_ENV
        fi

    - name: Deploy to Sakura Internet
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SAKURA_HOST }}
        username: ${{ secrets.SAKURA_USERNAME }}
        password: ${{ secrets.SAKURA_PASSWORD }}
        port: ${{ secrets.SAKURA_PORT }}
        source: "deploy.tar.gz"
        target: "${{ env.DEPLOY_PATH }}"
        strip_components: 0
    
    - name: Execute deployment commands
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SAKURA_HOST }}
        username: ${{ secrets.SAKURA_USERNAME }}
        password: ${{ secrets.SAKURA_PASSWORD }}
        port: ${{ secrets.SAKURA_PORT }}
        script: |
          # デプロイパスを設定
          if [ -n "${{ secrets.SAKURA_DEPLOY_PATH }}" ]; then
            DEPLOY_PATH="${{ secrets.SAKURA_DEPLOY_PATH }}"
          else
            DEPLOY_PATH="/home/${{ secrets.SAKURA_USERNAME }}/"
          fi
          
          # デプロイディレクトリに移動
          cd $DEPLOY_PATH
          
          # 既存のファイルをバックアップ
          if [ -d "kakeibo_backup" ]; then
            rm -rf kakeibo_backup
          fi
          if [ -d "kakeibo" ]; then
            mv kakeibo kakeibo_backup
          fi
          
          # 新しいファイルを展開
          tar -xzf deploy.tar.gz
          mv kakeibo kakeibo_temp
          mv kakeibo_temp/* kakeibo/
          rmdir kakeibo_temp
          
          # 環境変数ファイルを設定
          if [ ! -f "kakeibo/.env" ]; then
            cp kakeibo/env.example kakeibo/.env
          fi
          
          # 仮想環境を作成・更新
          cd kakeibo
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # データベースマイグレーション
          python manage.py migrate --noinput
          
          # 静的ファイルを収集
          python manage.py collectstatic --noinput
          
          # アプリケーションを再起動
          if [ -f "$DEPLOY_PATH/kakeibo.pid" ]; then
            kill $(cat $DEPLOY_PATH/kakeibo.pid) || true
            rm $DEPLOY_PATH/kakeibo.pid
          fi
          
          # 新しいプロセスを開始
          nohup $DEPLOY_PATH/kakeibo/venv/bin/gunicorn \
            --bind 0.0.0.0:${{ secrets.SAKURA_PORT }} \
            --workers 2 \
            --pid $DEPLOY_PATH/kakeibo.pid \
            kakeibo_project.wsgi:application > $DEPLOY_PATH/kakeibo.log 2>&1 &
          
          # デプロイ完了
          echo "Deployment completed successfully!" 