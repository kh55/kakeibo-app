name: Deploy to Sakura Internet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        python manage.py test
    
    - name: Collect static files
      run: |
        python manage.py collectstatic --noinput
    
    - name: Create deployment package
      run: |
        mkdir -p temp_deploy
        
        # ディレクトリをコピー
        for item in kakeibo_app kakeibo_project templates static; do
          if [ -d "$item" ]; then
            cp -r "$item" temp_deploy/
          else
            echo "Warning: Directory $item not found"
          fi
        done
        
        # ファイルをコピー
        for item in manage.py requirements.txt Procfile runtime.txt env.example sakura_settings.py env.sakura.example gunicorn_sakura.conf.py Procfile.sakura DEPLOY_SAKURA.md; do
          if [ -f "$item" ]; then
            cp "$item" temp_deploy/
          else
            echo "Warning: File $item not found"
          fi
        done
        
        cd temp_deploy
        tar -czf ../deploy.tar.gz .
        cd ..
        rm -rf temp_deploy

    - name: Deploy to Sakura Internet
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SAKURA_HOST }}
        username: ${{ secrets.SAKURA_USERNAME }}
        password: ${{ secrets.SAKURA_PASSWORD }}
        key: ${{ secrets.SAKURA_SSH_KEY || '' }}
        port: 22
        source: "deploy.tar.gz"
        target: "${{ secrets.SAKURA_DEPLOY_PATH || format('/home/{0}/', secrets.SAKURA_USERNAME) }}"
        strip_components: 0
        debug: ${{ github.event_name == 'workflow_dispatch' }}
    
    - name: Execute deployment commands
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SAKURA_HOST }}
        username: ${{ secrets.SAKURA_USERNAME }}
        password: ${{ secrets.SAKURA_PASSWORD }}
        key: ${{ secrets.SAKURA_SSH_KEY || '' }}
        port: 22
        script: |
          DEPLOY_PATH="${{ secrets.SAKURA_DEPLOY_PATH || format('/home/{0}/', secrets.SAKURA_USERNAME) }}"
          APP_PORT="${{ secrets.SAKURA_APP_PORT || '8000' }}"
          
          echo "Deploying to: $DEPLOY_PATH"
          echo "Application port: $APP_PORT"
          
          cd "$DEPLOY_PATH"
          
          # バックアップ
          if [ -d "kakeibo_backup" ]; then
            rm -rf kakeibo_backup
          fi
          if [ -d "kakeibo" ]; then
            mv kakeibo kakeibo_backup
          fi
          
          # ファイル展開
          tar -xzf deploy.tar.gz
          if [ -d "kakeibo" ]; then
            mv kakeibo kakeibo_temp
            mv kakeibo_temp/* kakeibo/
            rmdir kakeibo_temp
          else
            mkdir kakeibo
            mv * kakeibo/ 2>/dev/null || true
          fi
          
          # 環境変数ファイル設定
          if [ ! -f "kakeibo/.env" ] && [ -f "kakeibo/env.example" ]; then
            cp kakeibo/env.example kakeibo/.env
            echo "Created .env file from template"
          fi
          
          cd kakeibo
          
          # 仮想環境作成
          if [ ! -d "venv" ]; then
            echo "Creating virtual environment..."
            python3 -m venv venv || exit 1
          fi
          
          echo "Activating virtual environment..."
          source venv/bin/activate
          
          echo "Installing dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt || exit 1
          
          echo "Running database migrations..."
          python manage.py migrate --noinput || exit 1
          
          echo "Collecting static files..."
          python manage.py collectstatic --noinput || exit 1
          
          echo "Restarting application..."
          if [ -f "$DEPLOY_PATH/kakeibo.pid" ]; then
            kill $(cat "$DEPLOY_PATH/kakeibo.pid") || true
            rm "$DEPLOY_PATH/kakeibo.pid"
          fi
          
          nohup "$DEPLOY_PATH/kakeibo/venv/bin/gunicorn" \
            --bind "0.0.0.0:$APP_PORT" \
            --workers 2 \
            --pid "$DEPLOY_PATH/kakeibo.pid" \
            kakeibo_project.wsgi:application > "$DEPLOY_PATH/kakeibo.log" 2>&1 &
          
          sleep 3
          if [ -f "$DEPLOY_PATH/kakeibo.pid" ]; then
            echo "Application started successfully with PID: $(cat $DEPLOY_PATH/kakeibo.pid)"
          else
            echo "Error: Application failed to start"
            exit 1
          fi
          
          echo "Deployment completed successfully!" 