name: Deploy to Sakura Internet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SAKURA_HOST }}
        username: ${{ secrets.SAKURA_USERNAME }}
        password: ${{ secrets.SAKURA_PASSWORD }}
        script: |
          cd ${{ secrets.SAKURA_DEPLOY_PATH }}
          git pull origin main
          
          # 段階1: 環境確認
          echo "=== 環境確認 ==="
          echo "Python version:"
          python3 --version || echo "Python3 not found"
          echo "Pip version:"
          pip3 --version || pip --version || echo "Pip not found"
          echo "Current directory:"
          pwd
          echo "Directory contents:"
          ls -la
          echo "=================="
          
          # 段階2: 仮想環境の確認・作成
          echo "=== 仮想環境確認 ==="
          if [ -d "venv" ]; then
            echo "仮想環境が存在します"
            echo "仮想環境のPython:"
            venv/bin/python --version || echo "仮想環境のPythonが見つかりません"
          else
            echo "仮想環境が存在しません。作成します..."
            python3 -m venv venv
            echo "仮想環境を作成しました"
          fi
          
          echo "仮想環境をアクティベート..."
          source venv/bin/activate
          echo "アクティベート後のPython:"
          python --version
          echo "アクティベート後のPip:"
          pip --version
          echo "=====================" 