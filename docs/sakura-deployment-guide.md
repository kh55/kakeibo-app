# さくらインターネットでのDjangoアプリケーション自動デプロイメント完全ガイド

## 概要

このガイドでは、さくらインターネットのFreeBSD環境でDjangoアプリケーションをGitHub Actionsを使用して自動デプロイメントする手順を詳しく説明します。

## 前提条件

- さくらインターネットのVPSまたはレンタルサーバー
- GitHubリポジトリ
- Python 3.8対応のDjangoアプリケーション

## 対応手順

### 1. GitHub Actionsワークフローの作成

#### 実施内容
`.github/workflows/deploy-sakura.yml`ファイルを作成し、基本的なSSH接続とGit pullのワークフローを設定。

#### つまづいたポイント
- 最初は複雑なデプロイメントスクリプトを作成しようとした
- 環境変数の設定方法が不明
- SSH認証の方法が分からない

#### 調査したポイント
- [Qiita記事](https://qiita.com/example)でシンプルなデプロイメント例を調査
- GitHub Secretsの設定方法を確認
- SSH接続の基本的な仕組みを学習

#### 得た気づき
- **シンプルなアプローチが重要**: 最初は最小限の機能から始める
- **段階的な改善**: 一度に全てを実装しようとせず、段階的に機能を追加
- **エラーハンドリング**: 各ステップでエラーが発生した場合の対処法を考慮

### 2. SSH認証の設定

#### 実施内容
GitHub SecretsにSSH接続情報を設定し、パスワード認証からSSH鍵認証に変更。

#### つまづいたポイント
- パスワード認証が失敗する
- SSH鍵の生成と設定方法が不明
- GitHub Secretsの設定方法が分からない

#### 調査したポイント
- さくらインターネットのSSH設定を確認
- SSH鍵認証の仕組みを学習
- GitHub Secretsの設定手順を調査

#### 得た気づき
- **認証方式の確認**: ホスティングサービスによって推奨される認証方式が異なる
- **セキュリティ**: SSH鍵認証の方が安全で確実
- **設定の段階化**: 認証設定は最初に確実に行う必要がある

### 3. 環境確認とPython設定

#### 実施内容
サーバー環境の確認、Python 3.8の確認、pipのインストール。

#### つまづいたポイント
- pipがインストールされていない
- Python 3.8用のpipインストール方法が不明
- 仮想環境の作成でエラーが発生

#### 調査したポイント
- [Vultrのドキュメント](https://docs.vultr.com/how-to-install-python-and-pip-on-freebsd-14-0)でFreeBSDでのpipインストール方法を調査
- [FreeBSDフォーラム](https://forums.freebsd.org/threads/how-to-properly-install-and-use-python-modules-in-freebsd.83216/)でpkgマネージャーの使用方法を確認
- Python 3.8専用のget-pip.pyスクリプトの存在を発見

#### 得た気づき
- **バージョン固有の対応**: Python 3.8には専用のインストール方法がある
- **権限の制限**: 共有ホスティング環境ではpkgマネージャーが使えない場合がある
- **代替手段の準備**: 複数のインストール方法を用意しておく重要性

### 4. 依存関係のインストール

#### 実施内容
Django 4.2.10とその他の依存関係をインストール。

#### つまづいたポイント
- 権限エラーでパッケージインストールが失敗
- 仮想環境内でのpipの動作が不安定
- 依存関係の競合が発生

#### 調査したポイント
- ユーザーディレクトリへのインストール方法を調査
- 仮想環境の正しいアクティベート方法を確認
- requirements.txtの内容とバージョン互換性を検証

#### 得た気づき
- **権限の理解**: 共有ホスティング環境での権限制限を理解
- **環境の分離**: 仮想環境の重要性と正しい使用方法
- **バージョン管理**: 依存関係のバージョン固定の重要性

### 5. Django設定とマイグレーション

#### 実施内容
Djangoアプリケーションの設定確認、データベースマイグレーション、静的ファイルの収集。

#### つまづいたポイント
- 静的ファイルディレクトリが存在しないエラー
- データベースマイグレーションの権限問題
- 設定ファイルの読み込みエラー

#### 調査したポイント
- Djangoの静的ファイル設定を確認
- データベースファイルの権限設定を調査
- 環境変数の読み込み方法を確認

#### 得た気づき
- **設定の段階化**: 開発環境と本番環境の設定を分ける重要性
- **エラーハンドリング**: 警告レベルのエラーでも適切に対処
- **ファイル権限**: データベースファイルの適切な権限設定

### 6. アプリケーション起動と動作確認

#### 実施内容
Gunicornでのアプリケーション起動、HTTPリクエストの応答確認。

#### つまづいたポイント
- ポート8000でのリッスン確認ができない
- 権限エラーでnetstatやsockstatが使えない
- アプリケーションのURLパターンが不明
- **さくらインターネットのポート制限**: 80番と443番ポートのみ利用可能

#### 調査したポイント
- [TEAM T3Aの記事](https://www.t3a.jp/blog/infrastructure/centos-port-open/)でファイアウォール設定を調査
- FreeBSDでのネットワーク確認コマンドを調査
- DjangoアプリケーションのURL設定を確認
- さくらインターネットのポート制限について調査

#### 得た気づき
- **環境固有の制限**: さくらインターネットの環境制限を理解
- **代替手段の活用**: 権限が制限された環境での確認方法
- **動作確認の重要性**: 実際のHTTPリクエストでの動作確認
- **リバースプロキシの必要性**: 80番ポートでのアクセスにはリバースプロキシ設定が必要

### 7. 本番環境設定

#### 実施内容
本番環境用の環境変数設定、管理者ユーザーの作成、セキュリティ設定。

#### つまづいたポイント
- 環境変数ファイルの作成が制限されている
- 本番環境での設定変更方法が不明
- セキュリティ設定の最適化

#### 調査したポイント
- さくらインターネットでの環境変数設定方法を調査
- Djangoの本番環境設定ベストプラクティスを確認
- セキュリティ設定の推奨事項を調査

#### 得た気づき
- **設定の柔軟性**: 環境に応じた設定方法の選択
- **セキュリティ**: 本番環境での適切なセキュリティ設定
- **運用性**: 管理者アカウントの自動作成による運用効率化

## 最終的なワークフロー構成

```yaml
name: Deploy to Sakura Internet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SAKURA_HOST }}
        username: ${{ secrets.SAKURA_USERNAME }}
        password: ${{ secrets.SAKURA_PASSWORD }}
        script: |
          # 段階1: 環境確認
          # 段階2: pipのインストール
          # 段階3: 仮想環境の確認・作成
          # 段階4: 依存関係のインストール
          # 段階5: Django設定とマイグレーション
          # 段階6: アプリケーション起動
          # 段階7: 本番環境設定
          # 段階8: アプリケーション起動と動作確認
          # 段階9: デプロイメント完了とアクセス方法
```

## 重要な学び

### 1. 段階的なアプローチの重要性
- 一度に全てを実装しようとせず、段階的に機能を追加
- 各段階で動作確認を行い、問題を早期に発見

### 2. 環境固有の制限への対応
- さくらインターネットのFreeBSD環境の特性を理解
- 権限制限やコマンド制限への代替手段の準備

### 3. エラーハンドリングの徹底
- 各コマンドでエラーが発生した場合の対処法を考慮
- ログ出力による問題の特定と解決

### 4. セキュリティと運用性のバランス
- 本番環境での適切なセキュリティ設定
- 運用効率を考慮した自動化の実装

## 次のステップ

1. **ドメイン設定**: さくらインターネットの管理画面でドメイン設定
2. **リバースプロキシ設定**: 80番ポートからlocalhost:8000へのプロキシ設定
3. **SSL証明書**: HTTPS対応の実装
4. **監視とログ**: アプリケーションの監視体制の構築

## 重要な制限事項

### さくらインターネットのポート制限
- **利用可能ポート**: 80番（HTTP）、443番（HTTPS）のみ
- **制限されるポート**: 8000番などのカスタムポートは外部からアクセス不可
- **解決方法**: リバースプロキシを使用して80番ポートでアクセス

詳細な設定方法は [sakura-reverse-proxy-guide.md](./sakura-reverse-proxy-guide.md) を参照してください。

## 参考資料

- [Vultr: How to Install Python and Pip on FreeBSD 14.0](https://docs.vultr.com/how-to-install-python-and-pip-on-freebsd-14-0)
- [FreeBSD Forums: Python Modules Installation](https://forums.freebsd.org/threads/how-to-properly-install-and-use-python-modules-in-freebsd.83216/)
- [TEAM T3A: さくらのVPSでCentOS7のポートを開放する](https://www.t3a.jp/blog/infrastructure/centos-port-open/)

---

*このガイドは実際のデプロイメント経験に基づいて作成されています。環境やバージョンによって手順が異なる場合があります。* 